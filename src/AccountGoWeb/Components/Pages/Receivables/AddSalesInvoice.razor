@page "/receivables/add-sales-invoice"
@using Dto.Sales
@rendermode InteractiveServer

<PageTitle>Add Sales Invoice</PageTitle>

<h3>Add Sales Invoice</h3>

<style>
    .invoice-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .form-label {
        margin-bottom: 5px;
    }

    .invoice-table {
        background-color: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }

    .invoice-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 12px;
    }

    .invoice-table td {
        padding: 8px;
        background-color: white;
    }
</style>

<EditForm Model="@Model" OnValidSubmit="HandleValidSubmit" FormName="salesInvoiceForm">
    <DataAnnotationsValidator />
    
    <div class="invoice-card">
        @* Customer *@
        <div class="row mb-3">
            <div class="col-sm-2">
                <label class="form-label">Customer</label>
            </div>
            <div class="col-sm-10">
                <InputSelect class="form-control" @bind-Value="Model.CustomerId" id="optCustomer">
                    <option value="">-- Select Customer --</option>
                    @foreach (var customer in Customers)
                    {
                        <option value="@customer.Value">@customer.Text</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Model.CustomerId)" class="text-danger" />
            </div>
        </div>
        
        @* Payment Term *@
        <div class="row mb-3">
            <div class="col-sm-2">
                <label class="form-label">Payment Term</label>
            </div>
            <div class="col-sm-10">
                <InputSelect class="form-control" @bind-Value="Model.PaymentTermId" id="optPayment">
                    <option value="">-- Select Payment Term --</option>
                    @foreach (var paymentTerm in PaymentTerms)
                    {
                        <option value="@paymentTerm.Value">@paymentTerm.Text</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Model.PaymentTermId)" class="text-danger" />
            </div>
        </div>
        
        @* Posted *@
        <div class="row mb-4">
            <div class="col-sm-2">
                <label class="form-label">Posted</label>
            </div>
            <div class="col-sm-10">
                <InputCheckbox @bind-Value="Model.Posted" id="chkPosted" />
                <ValidationMessage For="@(() => Model.Posted)" class="text-danger" />
            </div>
        </div>

        @* Invoice Lines Table *@
        <div class="invoice-table">
            <table class="table table-borderless mb-0">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Amount</th>
                        <th>Discount</th>
                        <th>Measurement</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.SalesInvoiceLines!.Count; i++)
                    {
                        var index = i;
                        var line = Model.SalesInvoiceLines[i];
                        
                        <tr>
                            <td>
                                <InputSelect class="form-control" 
                                            @bind-Value="line.ItemId" 
                                            @bind-Value:after="@(() => OnItemChanged(index))">
                                    <option value="">-- Select Item --</option>
                                    @foreach (var item in Items)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </InputSelect>
                            </td>
                            <td>
                                <InputNumber class="form-control" 
                                            @bind-Value="line.Quantity"
                                            @bind-Value:after="@(() => OnQuantityChanged(index))" />
                            </td>
                            <td>
                                <InputNumber class="form-control" 
                                            @bind-Value="line.Amount"
                                            @bind-Value:after="@(() => OnAmountChanged(index))" />
                            </td>
                            <td>
                                <InputNumber class="form-control" 
                                            @bind-Value="line.Discount"
                                            @bind-Value:after="@(() => OnDiscountChanged(index))" />
                            </td>
                            <td>
                                <InputSelect class="form-control" 
                                            @bind-Value="line.MeasurementId"
                                            @bind-Value:after="@(() => OnMeasurementChanged(index))">
                                    <option value="">-- Select Measurement --</option>
                                    @foreach (var measurement in Measurements)
                                    {
                                        <option value="@measurement.Value">@measurement.Text</option>
                                    }
                                </InputSelect>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="mt-3">
        <button class="btn btn-info" type="submit">Save</button>
        <a href="/receivables/sales-invoices" class="btn btn-secondary">Close</a>
    </div>
</EditForm>

@code {
    private SalesInvoice Model { get; set; } = new();
    
    private List<SelectListItem> Customers { get; set; } = new();
    private List<SelectListItem> PaymentTerms { get; set; } = new();
    private List<SelectListItem> Items { get; set; } = new();
    private List<SelectListItem> Measurements { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Model.SalesInvoiceLines = new List<SalesInvoiceLine>
        {
            new SalesInvoiceLine()
        };
        
        await LoadDropdownData();
    }

    private async Task LoadDropdownData()
    {
        // TODO: Replace with actual API calls
        Customers = new List<SelectListItem>
        {
            new SelectListItem { Value = "1", Text = "Acme Corporation" },
            new SelectListItem { Value = "2", Text = "Global Industries" },
            new SelectListItem { Value = "3", Text = "Tech Solutions Inc" }
        };

        PaymentTerms = new List<SelectListItem>
        {
            new SelectListItem { Value = "1", Text = "Net 30" },
            new SelectListItem { Value = "2", Text = "Net 60" },
            new SelectListItem { Value = "3", Text = "Due on Receipt" }
        };

        Items = new List<SelectListItem>
        {
            new SelectListItem { Value = "1", Text = "HOA Dues" },
            new SelectListItem { Value = "2", Text = "Service Fee" },
            new SelectListItem { Value = "3", Text = "Maintenance" }
        };

        Measurements = new List<SelectListItem>
        {
            new SelectListItem { Value = "1", Text = "Each" },
            new SelectListItem { Value = "2", Text = "Box" },
            new SelectListItem { Value = "3", Text = "Unit" }
        };
        
        await Task.CompletedTask;
    }

    private async Task HandleValidSubmit()
    {
        Console.WriteLine("Form submitted.");
        Console.WriteLine($"Customer: {Model.CustomerId}");
        Console.WriteLine($"Payment Term: {Model.PaymentTermId}");
        Console.WriteLine($"Posted: {Model.Posted}");
        
        // TODO: Save the invoice to the database/API
        // Example: await HttpClient.PostAsJsonAsync("/api/salesinvoices", Model);
        
        await Task.CompletedTask;
    }

    private void OnItemChanged(int index)
    {
        Console.WriteLine($"Row {index} Item selected: {Model.SalesInvoiceLines![index].ItemId}");
    }

    private void OnQuantityChanged(int index)
    {
        Console.WriteLine($"Row {index} Quantity changed to: {Model.SalesInvoiceLines![index].Quantity}");
    }

    private void OnAmountChanged(int index)
    {
        Console.WriteLine($"Row {index} Amount changed to: {Model.SalesInvoiceLines![index].Amount}");
    }

    private void OnDiscountChanged(int index)
    {
        Console.WriteLine($"Row {index} Discount changed to: {Model.SalesInvoiceLines![index].Discount}");
    }

    private void OnMeasurementChanged(int index)
    {
        Console.WriteLine($"Row {index} Measurement selected: {Model.SalesInvoiceLines![index].MeasurementId}");
    }

    public class SelectListItem
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }
}
