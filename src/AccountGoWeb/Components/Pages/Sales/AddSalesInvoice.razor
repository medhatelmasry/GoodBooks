
@page "/sales/add-sales-invoice"
@page "/sales/salesinvoice/{Id:int}"
@using Dto.Sales
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>@(Id.HasValue ? "Edit" : "Add") Sales Invoice</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3>@(Id.HasValue ? "Edit" : "Add") Sales Invoice</h3>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="row">
            <div class="col text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading form data...</p>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="row">
            <div class="col">
                <div class="alert alert-danger" role="alert">
                    <i class="fa fa-exclamation-triangle"></i> @errorMessage
                </div>
            </div>
        </div>
    }
    else
    {
        <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit" FormName="salesInvoiceForm">
            <DataAnnotationsValidator />
            
            <div class="card">
                <div class="card-body">
                    @* Customer *@
                    <div class="row mb-3">
                        <div class="col-sm-2">
                            <label class="form-label">Customer</label>
                        </div>
                        <div class="col-sm-10">
                            <InputSelect class="form-control" @bind-Value="Model.CustomerId" id="optCustomer">
                                <option value="">-- Select Customer --</option>
                                @foreach (var customer in Customers)
                                {
                                    <option value="@customer.Value">@customer.Text</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Model.CustomerId)" class="text-danger" />
                        </div>
                    </div>
                    
                    @* Payment Term *@
                    <div class="row mb-3">
                        <div class="col-sm-2">
                            <label class="form-label">Payment Term</label>
                        </div>
                        <div class="col-sm-10">
                            <InputSelect class="form-control" @bind-Value="Model.PaymentTermId" id="optPayment">
                                <option value="">-- Select Payment Term --</option>
                                @foreach (var paymentTerm in PaymentTerms)
                                {
                                    <option value="@paymentTerm.Value">@paymentTerm.Text</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Model.PaymentTermId)" class="text-danger" />
                        </div>
                    </div>
                    
                    @* Posted *@
                    <div class="row mb-4">
                        <div class="col-sm-2">
                            <label class="form-label">Posted</label>
                        </div>
                        <div class="col-sm-10">
                            <InputCheckbox @bind-Value="Model.Posted" id="chkPosted" />
                            <ValidationMessage For="@(() => Model.Posted)" class="text-danger" />
                        </div>
                    </div>

                    @* Invoice Lines Table *@
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Discount</th>
                                    <th>Measurement</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.SalesInvoiceLines!.Count; i++)
                                {
                                    var index = i;
                                    var line = Model.SalesInvoiceLines[i];
                                    
                                    <tr>
                                        <td>
                                            <InputSelect class="form-control" 
                                                        @bind-Value="line.ItemId" 
                                                        @bind-Value:after="@(() => OnItemChanged(index))">
                                                <option value="">-- Select Item --</option>
                                                @foreach (var item in Items)
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            </InputSelect>
                                        </td>
                                        <td>
                                            <InputNumber class="form-control" 
                                                        @bind-Value="line.Quantity"
                                                        @bind-Value:after="@(() => OnQuantityChanged(index))" />
                                        </td>
                                        <td>
                                            <InputNumber class="form-control" 
                                                        @bind-Value="line.Amount"
                                                        @bind-Value:after="@(() => OnAmountChanged(index))" />
                                        </td>
                                        <td>
                                            <InputNumber class="form-control" 
                                                        @bind-Value="line.Discount"
                                                        @bind-Value:after="@(() => OnDiscountChanged(index))" />
                                        </td>
                                        <td>
                                            <InputSelect class="form-control" 
                                                        @bind-Value="line.MeasurementId"
                                                        @bind-Value:after="@(() => OnMeasurementChanged(index))">
                                                <option value="">-- Select Measurement --</option>
                                                @foreach (var measurement in Measurements)
                                                {
                                                    <option value="@measurement.Value">@measurement.Text</option>
                                                }
                                            </InputSelect>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col">
                    <button class="btn btn-primary" type="submit">
                        <i class="fa fa-save"></i> @(Id.HasValue ? "Update" : "Save")
                    </button>
                    <button class="btn btn-secondary ms-2" type="button" @onclick="NavigateToInvoiceList">
                        <i class="fa fa-times"></i> Close
                    </button>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter]
    public int? Id { get; set; }

    private SalesInvoice Model { get; set; } = new();
    
    private List<SelectListItem> Customers { get; set; } = new();
    private List<SelectListItem> PaymentTerms { get; set; } = new();
    private List<SelectListItem> Items { get; set; } = new();
    private List<SelectListItem> Measurements { get; set; } = new();
    
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            await LoadInvoice();
        }
        else
        {
            Model.SalesInvoiceLines = new List<SalesInvoiceLine>
            {
                new SalesInvoiceLine()
            };
        }
        
        await LoadDropdownData();
    }

    private async Task LoadInvoice()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            string baseApiUrl = Environment.GetEnvironmentVariable("APIURL") ?? "http://localhost:8001/api/";
            var apiUrl = $"{baseApiUrl}sales/SalesInvoice?id={Id}";
            var response = await Http.GetAsync(apiUrl);

            if (response.IsSuccessStatusCode)
            {
                Model = await response.Content.ReadFromJsonAsync<SalesInvoice>() ?? new();
                
                if (Model?.SalesInvoiceLines == null || !Model.SalesInvoiceLines.Any())
                {
                    Model!.SalesInvoiceLines = new List<SalesInvoiceLine> { new SalesInvoiceLine() };
                }
            }
            else
            {
                errorMessage = $"Failed to load invoice. Status: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading invoice: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDropdownData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            string baseApiUrl = Environment.GetEnvironmentVariable("APIURL") ?? "http://localhost:8001/api/";
            
            // TODO: Replace with actual API calls to load dropdown data
            // Example: var customersResponse = await Http.GetAsync(baseApiUrl + "sales/customers");
            
            Customers = new List<SelectListItem>
            {
                new SelectListItem { Value = "1", Text = "Acme Corporation" },
                new SelectListItem { Value = "2", Text = "Global Industries" },
                new SelectListItem { Value = "3", Text = "Tech Solutions Inc" }
            };

            PaymentTerms = new List<SelectListItem>
            {
                new SelectListItem { Value = "1", Text = "Net 30" },
                new SelectListItem { Value = "2", Text = "Net 60" },
                new SelectListItem { Value = "3", Text = "Due on Receipt" }
            };

            Items = new List<SelectListItem>
            {
                new SelectListItem { Value = "1", Text = "HOA Dues" },
                new SelectListItem { Value = "2", Text = "Service Fee" },
                new SelectListItem { Value = "3", Text = "Maintenance" }
            };

            Measurements = new List<SelectListItem>
            {
                new SelectListItem { Value = "1", Text = "Each" },
                new SelectListItem { Value = "2", Text = "Box" },
                new SelectListItem { Value = "3", Text = "Unit" }
            };
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Network error: {ex.Message}. Please ensure the API is running on port 8001.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading form data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            string baseApiUrl = Environment.GetEnvironmentVariable("APIURL") ?? "http://localhost:8001/api/";
            var apiUrl = Id.HasValue 
                ? baseApiUrl + "sales/UpdateSalesInvoice"
                : baseApiUrl + "sales/SaveSalesInvoice";
            
            var response = await Http.PostAsJsonAsync(apiUrl, Model);
            
            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/sales/salesinvoices");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var action = Id.HasValue ? "update" : "save";
                errorMessage = $"Failed to {action} invoice. Status: {response.StatusCode}. Details: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            var action = Id.HasValue ? "updating" : "saving";
            errorMessage = $"Error {action} invoice: {ex.Message}";
        }
    }

    private void NavigateToInvoiceList()
    {
        Navigation.NavigateTo("/sales/salesinvoices");
    }

    private void OnItemChanged(int index)
    {
        Console.WriteLine($"Row {index} Item selected: {Model.SalesInvoiceLines![index].ItemId}");
    }

    private void OnQuantityChanged(int index)
    {
        Console.WriteLine($"Row {index} Quantity changed to: {Model.SalesInvoiceLines![index].Quantity}");
    }

    private void OnAmountChanged(int index)
    {
        Console.WriteLine($"Row {index} Amount changed to: {Model.SalesInvoiceLines![index].Amount}");
    }

    private void OnDiscountChanged(int index)
    {
        Console.WriteLine($"Row {index} Discount changed to: {Model.SalesInvoiceLines![index].Discount}");
    }

    private void OnMeasurementChanged(int index)
    {
        Console.WriteLine($"Row {index} Measurement selected: {Model.SalesInvoiceLines![index].MeasurementId}");
    }

    public class SelectListItem
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }
}
