@page "/receivables/sales-orders"
@using System.Text.Json
@using System.Text.Json.Serialization
@using Dto.Sales
@inject IHttpClientFactory ClientFactory
@inject NavigationManager NavigationManager

<PageTitle>Sales Orders</PageTitle>

<h3>Sales Orders</h3>

@if (isLoading)
{
    <p><em>Loading sales orders...</em></p>
}
else if (getError)
{
    <p>Unable to load sales orders. Please try again later.</p>
}
else if (salesOrders != null && salesOrders.Any())
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NavigateToNewOrder">
            <i class="bi bi-plus"></i> New Order
        </button>
        <button class="btn btn-secondary" @onclick="ViewSelectedOrder" disabled="@(selectedOrder == null)">
            <i class="bi bi-eye"></i> View
        </button>
        <button class="btn btn-success" @onclick="CreateInvoiceFromOrder" disabled="@(selectedOrder == null || selectedOrder.StatusId == 6)">
            <i class="bi bi-file-earmark-plus"></i> Create Invoice
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th></th>
                    <th>No</th>
                    <th>Customer Name</th>
                    <th>Order Date</th>
                    <th>Ref No</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in salesOrders)
                {
                    <tr @onclick="() => SelectOrder(order)" style="cursor: pointer;" class="@(selectedOrder?.Id == order.Id ? "table-active" : "")">
                        <td>
                            <input type="radio" name="selectedOrder" checked="@(selectedOrder?.Id == order.Id)" @onclick:stopPropagation="true" @onclick="() => SelectOrder(order)" />
                        </td>
                        <td>@order.No</td>
                        <td>@order.CustomerName</td>
                        <td>@order.OrderDate.ToShortDateString()</td>
                        <td>@order.ReferenceNo</td>
                        <td>@order.Amount?.ToString("C")</td>
                        <td>@GetStatusText(order.StatusId)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p>No sales orders found.</p>
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NavigateToNewOrder">
            <i class="bi bi-plus"></i> New Order
        </button>
    </div>
}

@code {
    private List<SalesOrder>? salesOrders;
    private SalesOrder? selectedOrder;
    private bool isLoading = true;
    private bool getError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSalesOrders();
    }

    private async Task LoadSalesOrders()
    {
        isLoading = true;
        getError = false;

        try
        {
            string apiUrl = System.Environment.GetEnvironmentVariable("APIURL") ?? "http://localhost:8001/api/";
            var request = new HttpRequestMessage(HttpMethod.Get, $"{apiUrl}sales/salesorders");
            request.Headers.Add("Accept", "application/json");

            var client = ClientFactory.CreateClient();
            client.DefaultRequestHeaders.Accept.Clear();
            client.DefaultRequestHeaders.Clear();
            client.DefaultRequestHeaders.CacheControl = new System.Net.Http.Headers.CacheControlHeaderValue() { NoCache = true };
            client.DefaultRequestHeaders.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request).ConfigureAwait(false);

            if (response.IsSuccessStatusCode)
            {
                var responseString = await response.Content.ReadAsStringAsync();
                var options = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
                };

                salesOrders = JsonSerializer.Deserialize<List<SalesOrder>>(responseString, options);
            }
            else
            {
                getError = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sales orders: {ex.Message}");
            getError = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectOrder(SalesOrder order)
    {
        selectedOrder = order;
    }

    private void NavigateToNewOrder()
    {
        NavigationManager.NavigateTo("/receivables/sales-order/new");
    }

    private void ViewSelectedOrder()
    {
        if (selectedOrder != null)
        {
            NavigationManager.NavigateTo($"/receivables/sales-order/{selectedOrder.Id}");
        }
    }

    private void CreateInvoiceFromOrder()
    {
        if (selectedOrder != null && selectedOrder.StatusId != 6)
        {
            NavigationManager.NavigateTo($"/receivables/sales-invoice/new?orderId={selectedOrder.Id}");
        }
    }

    private string GetStatusText(int statusId)
    {
        return statusId switch
        {
            1 => "Open",
            2 => "Partially Invoiced",
            3 => "Invoiced",
            4 => "Cancelled",
            5 => "Closed",
            6 => "Fully Invoiced",
            _ => "Unknown"
        };
    }
}
